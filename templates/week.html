<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch tuần</title>
    <style>
        body {
            font-family: system-ui;
            background: #F7F9FB;
        }
        .sidebar-week {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background: #FFFFFF;
            padding-bottom: 40px;
            min-width: 260px;
            border-radius: 6px;
            box-shadow: 0px 14px 21px #00000010;
        }
        .calendar-container {
            width: 240px;
            padding: 16px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        .calendar-header span {
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }
        table.calendar {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
            text-align: center;
        }
        table.calendar th, table.calendar td {
            padding: 6px;
            font-size: 15px;
        }
        table.calendar th {
            color: #0B41FF;
        }
        table.calendar td.selected {
            background: #0B41FF;
            color: #fff;
            border-radius: 50%;
        }
        table.calendar td:hover {
            background: #e6f0ff;
            cursor: pointer;
            border-radius: 50%;
        }
        .week-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .week-header-bar {
            display: flex;
            align-items: center;
            background: #FFFFFF;
            border-bottom: 1px solid #DADCE099;
            padding: 6px 16px 16px 16px;
            margin-left: 1px;
            margin-right: 1px;
        }
        .week-title {
            color: #333333;
            font-size: 30px;
            font-weight: bold;
            margin-right: 21px;
        }
        .week-switch-btn {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background: none;
            border-radius: 3px;
            border: 1px solid #0B41FF;
            padding: 8px;
            text-align: left;
            cursor: pointer;
            margin-right: 8px;
        }
        .week-switch-btn span {
            color: #0B41FF;
            font-size: 12px;
            font-weight: bold;
        }
        .avatar-img {
            width: 48px;
            height: 48px;
            margin-right: 19px;
            object-fit: fill;
            cursor: pointer;
            border-radius: 50%;
        }
        .search-bar {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background: #F5F5F5;
            border-radius: 99px;
            padding: 8px 8px 8px 16px;
            position:relative;
            margin-right: 16px;
        }
        .add-event-btn {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background: #0B41FF;
            border-radius: 3px;
            border: none;
            padding: 8px;
            gap: 4px;
            text-align: left;
            margin-right: 8px;
        }
        .add-event-btn span {
            color: #FFFFFF;
            font-size: 12px;
            font-weight: bold;
        }
        .week-content {
            display: flex;
            align-items: flex-start;
            margin-left: 1px;
            margin-right: 1px;
        }
        .week-hour-col {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
        }
        .week-hour-row {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #eee;
            width: 100%;
            box-sizing: border-box;
        }
        .week-grid {
            display: flex;
            min-height: 1152px;
            background: #fff;
            border-radius: 6px;
            overflow: visible;
        }
        .week-day-col {
            flex: 1;
            min-width: 0;
            border-left: 1px solid #eee;
            position: relative;
            /* Không padding/margin để event không bị tràn */
        }
        .week-day-label {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #0B41FF;
            background: #F5F8FF;
            padding: 2px 0 0 0;
            border-bottom: none;
            margin-bottom: 0;
            line-height: 1.1;
        }
        .event-block {
            position: absolute;
            left: 0;
            width: auto;
            min-height: 36px;
            background: #BDFFDB;
            border-radius: 4px;
            border: 1.5px solid #8EDBB2;
            box-shadow: 0 2px 8px #0001;
            padding: 6px 10px;
            cursor: pointer;
            overflow: hidden;
            z-index: 2;
            max-width: 100%;
            box-sizing: border-box;
            /* margin: 2px; */
        }
        .event-block .event-title {
            font-size: 13px;
            font-weight: bold;
            color: #2C5A41;
        }
        .event-block .event-time {
            font-size: 12px;
            color: #2C5A41;
            font-weight: bold;
        }
        .event-list-week {
            width: 100%;
            margin-top: 24px;
        }
        .event-list-week h3 {
            margin-bottom: 12px;
            color: #0B41FF;
            font-size: 16px;
            text-align:center;
        }
        .event-list-week ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .event-list-week li {
            margin-bottom: 10px;
            padding: 10px 8px;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 4px #0001;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        .event-list-week .event-title {
            font-weight: bold;
            color: #0B41FF;
            font-size: 15px;
        }
        .event-list-week .event-time {
            color: #666;
            font-size: 13px;
            font-weight: bold;
        }
        .event-list-week .event-tag {
            color: #fff;
            background: #0B41FF;
            border-radius: 8px;
            font-size: 11px;
            padding: 2px 8px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
<div style="background: #FFFFFF; min-height: 100vh; position: relative;">
    <div style="align-self: stretch; display: flex; align-items: flex-start; background: #FFFFFF; border-radius: 6px; margin-top: 32px; margin-bottom: 1px; box-shadow: 0px 14px 21px #00000010;">
        <div class="sidebar-week">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prevMonth">&#8592;</button>
                    <span id="calendarMonth"></span>
                    <button id="nextMonth">&#8594;</button>
                </div>
                <table id="calendar" class="calendar"></table>
            </div>
            <div class="event-list-week">
                <h3>Sự kiện trong tuần</h3>
                {% for day in week_days %}
                {% set day_events = events_by_day[day.isoformat()] %}
                <div style="margin-bottom: 10px;">
                    <div style="color: #0B41FF; font-size: 15px; font-weight: bold; margin-bottom: 4px; text-align:center;">{{ day.strftime('%A, %d/%m') }}</div>
                    {% if day_events %}
                    <ul>
                        {% for event in day_events|sort(attribute='todo.start_time') %}
                        <li>
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span class="event-title">{{ event.todo.task }}</span>
                                <span class="event-time">{{ event.todo.start_time.strftime('%H:%M') if event.todo.start_time else '' }} - {{ event.todo.end_time.strftime('%H:%M') if event.todo.end_time else '' }}</span>
                                {% if event.todo.tag %}
                                <span class="event-tag">#{{ event.todo.tag }}</span>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div style="color: #888; font-size: 14px; text-align:center;">Không có sự kiện.</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="week-main-content">
            <div class="week-header-bar">
                <span class="week-title" id="weekTitle">{{ week_range }}</span>
                <button class="week-switch-btn" onclick="window.location.href='/day?date='+encodeURIComponent(selectedDate)">
                    <span>Day</span>
                </button>
                <button class="week-switch-btn" onclick="goToCurrentWeek()">
                    <span>Hiện tại</span>
                </button>
                <div style="flex: 1;"></div>
                <img
                    src="{% if user and user.avatar %}/static/avatar/{{ user.avatar }}{% elif user and (user.username|default('')) and (user.username+'.png') in (os.listdir('static/avatar') if os.path.exists('static/avatar') else []) %}/static/avatar/{{ user.username }}.png{% else %}https://via.placeholder.com/60{% endif %}"
                    class="avatar-img"
                    alt="avatar"
                    onclick="window.location.href='/profile'"
                />
                <div class="search-bar">
                    <input type="text" placeholder="Enter Search" id="eventSearchInput" style="color: #6A778B; font-size: 14px; font-weight: bold; width: 161px; background: none; border: none; z-index:2;" />
                    <img src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/5c0f54db-ffe1-4c35-b9e2-893e888c3290" style="border-radius: 99px; width: 16px; height: 16px; object-fit: fill; z-index:2;" />
                    <div id="search-suggestion-box" style="display:none; position:absolute; left:0; right:0; top:38px; z-index:100; background:#fff; border-radius:8px; box-shadow:0 2px 8px #0002; padding:8px 0; max-height:220px; overflow-y:auto;"></div>
                </div>
                <button class="add-event-btn" onclick="window.location.href='/add-event'">
                    <span>Add event</span>
                    <img src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/97437b4c-b5ea-45f9-aeb1-75d8a938a534" style="border-radius: 3px; width: 16px; height: 16px; object-fit: fill;" />
                </button>
            </div>
            <div class="week-content" style="display: flex; align-items: flex-start; margin-left: 1px; margin-right: 1px;">
                <div class="week-hour-col" style="z-index:2;">
                    <div style="height: 38px; background: #fff;"></div>
                    {% for hour in range(24) %}
                    <div class="week-hour-row">
                        <span style="color: #333333; font-size: 12px; font-weight: bold;">{{ '%02d:00' % hour }}</span>
                    </div>
                    {% endfor %}
                </div>
                <div style="flex:1; display:flex; flex-direction:column;">
                    <div style="display:flex;">
                        {% for day in week_days %}
                        <div class="week-day-col" style="background:#F5F8FF; border-bottom:1px solid #eee; text-align:center; height:38px; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:0; flex:1; min-width:0;">
                            <span class="week-day-label" style="font-size:15px;line-height:1.1;margin-bottom:0;">{{ day.strftime('%a') }}</span>
                            <span class="week-day-label" style="font-size:13px;line-height:1.1;margin-top:0;">{{ day.strftime('%d/%m') }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="week-grid" style="display:flex; min-height:1152px; background:#fff; border-radius:6px; overflow:visible;">
                        {% for day in week_days %}
                        <div class="week-day-col" style="flex:1; min-width:0; border-left:1px solid #eee; position:relative;">
                            {% set day_iso = day.isoformat() %}
                            {% set day_events = events_by_day[day_iso]|sort(attribute='todo.start_time') %}
                            {% for event in day_events %}
                                {% set start_minutes = event.todo.start_time.hour * 60 + event.todo.start_time.minute if event.todo.start_time else 0 %}
                                {% set end_minutes = event.todo.end_time.hour * 60 + event.todo.end_time.minute if event.todo.end_time else (start_minutes + 60) %}
                                {% set top = (start_minutes / 60) * 48 %}
                                {% set height = ((end_minutes - start_minutes) / 60) * 48 %}
                                {% set left = (event.column / event.total_columns) * 100 %}
                                {% set width = (1 / event.total_columns) * 100 %}
                                {% set tag_color = {
                                    'work':   '#B2D7FF',
                                    'study':  '#FFE6A7',
                                    'personal': '#FFD6E0',
                                    'meeting': '#D6FFD6',
                                    'health': '#E0D6FF',
                                    'family': '#FFF2B2',
                                    'travel': '#B2FFF2',
                                    'other':  '#F5F5F5'
                                }.get(event.todo.tag|lower, '#BDFFDB') %}
                                {% set tag_border = {
                                    'work':   '#5CA8F7',
                                    'study':  '#FFC14A',
                                    'personal': '#FF7A9E',
                                    'meeting': '#8EDBB2',
                                    'health': '#A18CFF',
                                    'family': '#FFD84A',
                                    'travel': '#4ADBC1',
                                    'other':  '#8EDBB2'
                                }.get(event.todo.tag|lower, '#8EDBB2') %}
                                <div class="event-block" 
                                    data-tag="{{ event.todo.tag|default('') }}"
                                    style="position: absolute; top: {{ top }}px; left: {{ left }}%; width: calc({{ width }}% - 6px); height: {{ height }}px; background: {{ tag_color }}; border-radius: 4px; border: 1.5px solid {{ tag_border }}; box-shadow: 0 2px 8px #0001; padding: 6px 10px; cursor: pointer; overflow: hidden; z-index: {{ 100 - event.column }}; box-sizing: border-box;"
                                    onclick="window.location.href='/edit-event/{{ event.todo.id }}'"
                                >
                                    <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%; gap: 2px;">
                                        <span class="event-title" style="color: #2C5A41; font-size: 13px; font-weight: bold; word-break: break-word; white-space: pre-line;">{{ event.todo.task }}</span>
                                        <span class="event-time" style="color: #2C5A41; font-size: 12px; font-weight: bold; word-break: break-word; white-space: pre-line;">{{ event.todo.start_time.strftime('%H:%M') if event.todo.start_time else '' }}-{{ event.todo.end_time.strftime('%H:%M') if event.todo.end_time else '' }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// --- Calendar rendering logic giống day.html ---
const calendar = document.getElementById('calendar');
const calendarMonth = document.getElementById('calendarMonth');
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');
let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();
let selectedDate = null;
// --- SEARCH LOGIC giống day.html ---
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
function normalizeText(str) {
    return (str || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
}
const filterEvents = debounce(function() {
    const keyword = normalizeText(document.getElementById('eventSearchInput').value.trim());
    const suggestionBox = document.getElementById('search-suggestion-box');
    let matches = [];
    document.querySelectorAll('.event-block').forEach((item, idx) => {
        const title = normalizeText(item.querySelector('span.event-title')?.textContent || '');
        const tag = normalizeText(item.getAttribute('data-tag') || '');
        const timeSpan = item.querySelector('span.event-time');
        const time = timeSpan ? timeSpan.textContent.trim() : '';
        if (keyword && (title.includes(keyword) || tag.includes(keyword))) {
            matches.push({
                title: item.querySelector('span.event-title')?.textContent || '',
                time: time,
                tag: tag,
                element: item
            });
        }
    });
    matches.sort((a, b) => {
        const timeA = a.time ? a.time.split('-')[0].trim() : '23:59';
        const timeB = b.time ? b.time.split('-')[0].trim() : '23:59';
        return timeA.localeCompare(timeB);
    });
    if (keyword && matches.length > 0) {
        let html = matches.slice(0, 10).map((match, idx) => `
            <div class="search-suggestion-item" data-idx="${idx}" style="padding:6px 18px; cursor:pointer; font-size:15px; color:#0B41FF; border-bottom:1px solid #F0F0F0; display:flex; justify-content:space-between; align-items:center;" tabindex="0">
                <span>${match.title} ${match.tag ? `<span style=\"color:#666;font-size:13px;margin-left:8px;\">#${match.tag}</span>` : ''}</span>
                ${match.time ? `<span style=\"color:#666;font-size:13px;margin-left:12px;\">${match.time}</span>` : ''}
            </div>
        `).join('');
        suggestionBox.innerHTML = html;
        suggestionBox.style.display = '';
        Array.from(suggestionBox.children).forEach((child, idx) => {
            child.onclick = () => selectSuggestion(idx);
            child.onkeydown = e => {
                if (e.key === 'Enter') selectSuggestion(idx);
            };
        });
        highlightSuggestion(-1);
    } else if (keyword) {
        suggestionBox.innerHTML = `<div style=\"padding:6px 18px; font-size:15px; color:#666;\">Không tìm thấy sự kiện nào</div>`;
        suggestionBox.style.display = '';
    } else {
        suggestionBox.style.display = 'none';
    }
}, 300);
function selectSuggestion(idx) {
    const suggestionBox = document.getElementById('search-suggestion-box');
    const keyword = normalizeText(document.getElementById('eventSearchInput').value.trim());
    let matches = [];
    document.querySelectorAll('.event-block').forEach((item) => {
        const title = normalizeText(item.querySelector('span.event-title')?.textContent || '');
        const tag = normalizeText(item.getAttribute('data-tag') || '');
        if (keyword && (title.includes(keyword) || tag.includes(keyword))) {
            matches.push(item);
        }
    });
    if (matches[idx]) {
        const el = matches[idx];
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('search-highlight');
        setTimeout(() => el.classList.remove('search-highlight'), 1200);
        suggestionBox.style.display = 'none';
        document.getElementById('eventSearchInput').blur();
    }
}
let currentSuggestion = -1;
function highlightSuggestion(idx) {
    const suggestionBox = document.getElementById('search-suggestion-box');
    Array.from(suggestionBox.children).forEach((child, i) => {
        child.style.background = i === idx ? '#e6f0ff' : '';
    });
    currentSuggestion = idx;
}
const searchInput = document.getElementById('eventSearchInput');
const suggestionBox = document.getElementById('search-suggestion-box');
searchInput.addEventListener('input', filterEvents);
searchInput.addEventListener('focus', () => {
    if (suggestionBox.innerHTML) suggestionBox.style.display = '';
});
searchInput.addEventListener('keydown', e => {
    const items = Array.from(suggestionBox.children);
    if (!items.length || suggestionBox.style.display === 'none') return;
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        let next = (currentSuggestion + 1) % items.length;
        highlightSuggestion(next);
        items[next].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        let prev = (currentSuggestion - 1 + items.length) % items.length;
        highlightSuggestion(prev);
        items[prev].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter') {
        if (currentSuggestion >= 0) {
            selectSuggestion(currentSuggestion);
            e.preventDefault();
        }
    } else if (e.key === 'Escape') {
        suggestionBox.style.display = 'none';
        currentSuggestion = -1;
        searchInput.blur();
    }
});
document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !suggestionBox.contains(e.target)) {
        suggestionBox.style.display = 'none';
        currentSuggestion = -1;
    }
});
function renderCalendar(month, year, selectedDateStr = null) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    calendarMonth.textContent = monthNames[month] + ' ' + year;
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    let html = '';
    html += '<thead><tr>';
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    for (let d of days) html += `<th style="color:#888;font-size:12px;">${d}</th>`;
    html += '</tr></thead><tbody>';
    let startDay = (firstDay.getDay() + 6) % 7;
    let day = 1;
    for (let i = 0; i < 6; i++) {
        html += '<tr>';
        for (let j = 0; j < 7; j++) {
            if (i === 0 && j < startDay) {
                html += '<td></td>';
            } else if (day > lastDay.getDate()) {
                html += '<td></td>';
            } else {
                const dateObj = new Date(year, month, day);
                const thisDateStr = `${year}-${month+1}-${day}`;
                const isSelected = selectedDateStr === thisDateStr;
                const isToday = dateObj.getDate() === today.getDate() && dateObj.getMonth() === today.getMonth() && dateObj.getFullYear() === today.getFullYear();
                const isHighlight = isSelected ? 'selected' : '';
                const bgColor = isSelected ? '#0B41FF' : (isToday ? '#F5F5F5' : '#F5F5F5');
                const color = isSelected ? '#fff' : '#333';
                html += `<td class="${isHighlight}" style="padding:4px;"><button class="calendar-day" data-date="${thisDateStr}" style="width:28px;height:28px;border-radius:50%;border:none;background:${bgColor};color:${color};font-weight:bold;cursor:pointer;">${day}</button></td>`;
                day++;
            }
        }
        html += '</tr>';
        if (day > lastDay.getDate()) break;
    }
    html += '</tbody>';
    calendar.innerHTML = html;
    document.querySelectorAll('.calendar-day').forEach(btn => {
        btn.onclick = function() {
            const dateStr = this.getAttribute('data-date');
            window.location.href = '/week?date=' + dateStr;
        };
    });
}
window.onload = function() {
    const params = new URLSearchParams(window.location.search);
    let dateStr = params.get('date');
    let defaultDate;
    if (dateStr) {
        const [y, m, d] = dateStr.split('-').map(Number);
        defaultDate = new Date(y, m - 1, d);
        selectedDate = dateStr;
    } else {
        defaultDate = new Date(currentYear, currentMonth, today.getDate());
        selectedDate = `${defaultDate.getFullYear()}-${defaultDate.getMonth()+1}-${defaultDate.getDate()}`;
    }
    renderCalendar(defaultDate.getMonth(), defaultDate.getFullYear(), selectedDate);
    currentMonth = defaultDate.getMonth();
    currentYear = defaultDate.getFullYear();
    // Cập nhật lại các nút chuyển view để truyền đúng selectedDate
    document.querySelectorAll('.week-switch-btn').forEach(btn => {
        if (btn.textContent.trim() === 'Month') {
            btn.onclick = function() {
                window.location.href = '/month?date=' + encodeURIComponent(selectedDate);
            }
        }
        if (btn.textContent.trim() === 'Day') {
            btn.onclick = function() {
                window.location.href = '/day?date=' + encodeURIComponent(selectedDate);
            }
        }
    });
};
prevMonthBtn.onclick = function() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar(currentMonth, currentYear, selectedDate);
};
nextMonthBtn.onclick = function() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar(currentMonth, currentYear, selectedDate);
};
function changeWeek(offset) {
    const params = new URLSearchParams(window.location.search);
    let date = params.get('date');
    if (!date) {
        const today = new Date();
        date = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
    }
    let d = new Date(date);
    if (isNaN(d.getTime())) {
        d = new Date();
    }
    d.setDate(d.getDate() + offset * 7);
    const newDate = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    window.location.href = '/week?date=' + newDate;
}
function goToCurrentWeek() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}-${(today.getMonth()+1)}-${today.getDate()}`;
    window.location.href = '/week?date=' + dateStr;
}
</script>
</body>
</html>