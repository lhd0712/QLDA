<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Day</title>
	<style>
		body {
			font-family: system-ui;
		}
		.calendar-container {
			position: absolute;
			top: 30px;
			right: 40px;
			background: #fff;
			border-radius: 10px;
			box-shadow: 0 2px 8px #0002;
			padding: 20px;
			width: 320px;
		}
		.calendar-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.calendar-header button {
			background: #0B41FF;
			color: #fff;
			border: none;
			border-radius: 4px;
			padding: 4px 10px;
			font-size: 16px;
			cursor: pointer;
		}
		.calendar-header span {
			font-size: 18px;
			font-weight: bold;
		}
		table.calendar {
			width: 100%;
			border-collapse: collapse;
			text-align: center;
		}
		table.calendar th, table.calendar td {
			padding: 6px;
			font-size: 15px;
		}
		table.calendar th {
			color: #0B41FF;
		}
		table.calendar td.selected {
			background: #0B41FF;
			color: #fff;
			border-radius: 50%;
		}
		table.calendar td:hover {
			background: #e6f0ff;
			cursor: pointer;
			border-radius: 50%;
		}
	</style>
</head>
<body>
	<div style="background: #FFFFFF; min-height: 100vh; position: relative;">
        <div class="calendar-container" id="calendar-box" style="display: none;">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)">&lt;</button>
                <span id="calendar-month"></span>
                <button onclick="changeMonth(1)">&gt;</button>
            </div>
            <table class="calendar">
                <thead>
                    <tr>
                        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    <!-- Calendar days will be rendered here -->
                </tbody>
            </table>
        </div>
		<div style="background: #FFFFFF;">
		<div style="align-self: stretch; display: flex; align-items: flex-start; background: #FFFFFF; border-radius: 6px; margin-top: 102px; margin-bottom: 1px; box-shadow: 0px 14px 21px #00000040;">
			<div style="flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-start; background: #FFFFFF; padding-bottom: 245px; min-width: 260px;">
				<div id="calendar-container" style="width: 240px; padding: 16px;">
					<div style="display: flex; justify-content: space-between; align-items: center;">
						<button id="prevMonth" style="background: none; border: none; font-size: 18px; cursor: pointer;">&#8592;</button>
						<span id="calendarMonth" style="color: #333; font-size: 18px; font-weight: bold;"></span>
						<button id="nextMonth" style="background: none; border: none; font-size: 18px; cursor: pointer;">&#8594;</button>
					</div>
					<table id="calendar" style="width: 100%; margin-top: 10px; border-collapse: collapse; text-align: center;"></table>
				</div>
				<!-- Block Sự kiện trong ngày ngay bên dưới calendar -->
				<div style="width: 100%; margin-top: 24px;">
					<h3 style="margin-bottom: 12px; color: #0B41FF; font-size: 16px; text-align:center;">Sự kiện trong ngày</h3>
					{% if todos %}
						<ul style="list-style: none; padding: 0; margin: 0;">
							{% for todo in todos|sort(attribute='start_time') %}
								<li style="margin-bottom: 10px; padding: 10px 8px; background: #fff; border-radius: 6px; box-shadow: 0 1px 4px #0001; display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
									<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
										<span style="font-weight: bold; color: #0B41FF; font-size: 15px;">{{ todo.task }}</span>
										<span style="color: #666; font-size: 13px; font-weight: bold;">{{ todo.start_time.strftime('%H:%M') if todo.start_time else '' }} - {{ todo.end_time.strftime('%H:%M') if todo.end_time else '' }}</span>
										{% if todo.tag %}
											<span style="color: #fff; background: #0B41FF; border-radius: 8px; font-size: 11px; padding: 2px 8px; margin-left: 8px;">#{{ todo.tag }}</span>
										{% endif %}
									</div>
									<!-- Không hiển thị description ở cột trái -->
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<div style="color: #888; font-size: 14px; text-align:center;">Không có sự kiện nào trong ngày này.</div>
					{% endif %}
				</div>
				<!-- Block Sự kiện ngày mai -->
				<div style="width: 100%; margin-top: 18px;">
					<h3 style="margin-bottom: 12px; color: #FF7A00; font-size: 16px; text-align:center;">Sự kiện ngày mai</h3>
					{% if todos_tomorrow %}
						<ul style="list-style: none; padding: 0; margin: 0;">
							{% for todo in todos_tomorrow|sort(attribute='start_time') %}
								<li style="margin-bottom: 10px; padding: 10px 8px; background: #fff; border-radius: 6px; box-shadow: 0 1px 4px #0001; display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
									<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
										<span style="font-weight: bold; color: #FF7A00; font-size: 15px;">{{ todo.task }}</span>
										<span style="color: #666; font-size: 13px; font-weight: bold;">{{ todo.start_time.strftime('%H:%M') if todo.start_time else '' }} - {{ todo.end_time.strftime('%H:%M') if todo.end_time else '' }}</span>
										{% if todo.tag %}
											<span style="color: #fff; background: #FF7A00; border-radius: 8px; font-size: 11px; padding: 2px 8px; margin-left: 8px;">#{{ todo.tag }}</span>
										{% endif %}
									</div>
									<!-- Không hiển thị description ở cột trái -->
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<div style="color: #888; font-size: 14px; text-align:center;">Không có sự kiện nào cho ngày mai.</div>
					{% endif %}
				</div>
			</div>
			<div style="flex: 1;">
				<div style="align-self: stretch; display: flex; align-items: flex-start; background: #FFFFFF; border-bottom: 1px solid #DADCE099; padding: 6px 16px 16px 16px; margin-left: 1px; margin-right: 1px;">
					<div style="flex-shrink: 0; display: flex; align-items: center; margin-top: 10px;">
						<span style="color: #333333; font-size: 30px; font-weight: bold; margin-right: 21px;" >
							01 January 2022
						</span>
						<button style="flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-start; background: none; border-radius: 3px; border: 1px solid #0B41FF; padding: 8px; text-align: left;"
							onclick="window.location.href='/week?date=' + encodeURIComponent(selectedDate)">
							<span style="color: #0B41FF; font-size: 12px; font-weight: bold;" >
								Week
							</span>
						</button>
						<button style="flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-start; background: none; border-radius: 3px; border: 1px solid #0B41FF; padding: 8px; text-align: left;"
							onclick="window.location.href='/month?date=' + encodeURIComponent(selectedDate)">
							<span style="color: #0B41FF; font-size: 12px; font-weight: bold;" >
								Month
							</span>
						</button>
					</div>
					<div style="flex: 1; align-self: stretch;">
					</div>
					<img
						src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/5ecd1f77-01c7-4e8f-a2f7-f57f1c4180d0" 
						style="width: 60px; height: 53px; margin-right: 19px; object-fit: fill; cursor: pointer; border-radius: 50%;"
						alt="avatar"
						onclick="window.location.href='/profile'"
					/>
					<div style="flex-shrink: 0; display: flex; align-items: center; margin-top: 14px; gap: 16px;">
						<div style="flex-shrink: 0; display: flex; align-items: center; background: #F5F5F5; border-radius: 99px; padding: 8px 8px 8px 16px;">
							<input
								type="text"
								placeholder="Enter Search"
								style="color: #6A778B; font-size: 14px; font-weight: bold; width: 161px; background: none; border: none;"
							/>
							<img
								src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/5c0f54db-ffe1-4c35-b9e2-893e888c3290" 
								style="border-radius: 99px; width: 16px; height: 16px; object-fit: fill;"
							/>
						</div>
						<button style="flex-shrink: 0; display: flex; align-items: center; background: #0B41FF; border-radius: 3px; border: none; padding: 8px; gap: 4px; text-align: left;"
							onclick="window.location.href='/add-event'">
							<span style="color: #FFFFFF; font-size: 12px; font-weight: bold;" >
								Add event
							</span>
							<img
								src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/97437b4c-b5ea-45f9-aeb1-75d8a938a534" 
								style="border-radius: 3px; width: 16px; height: 16px; object-fit: fill;"
							/>
						</button>
					</div>
				</div>
				<div style="align-self: stretch; display: flex; align-items: flex-start; margin-left: 1px; margin-right: 1px;">
  <div style="flex-shrink: 0; display: flex; flex-direction: column; align-items: center; width: 60px;">
    {% for hour in range(24) %}
      <div style="height: 48px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #eee; width: 100%; box-sizing: border-box;">
        <span style="color: #333333; font-size: 12px; font-weight: bold;">{{ '%02d:00' % hour }}</span>
      </div>
    {% endfor %}
  </div>
  <!-- Cột nội dung bên phải: event kéo dài và xếp chồng -->
  <div style="flex: 1; position: relative; min-height: 1152px; background: #fff; border-radius: 6px; overflow: visible;">
    <!-- Render các ô giờ làm nền -->
    {% for hour in range(24) %}
      <div style="position: absolute; left: 0; right: 0; top: {{ hour*48 }}px; height: 48px; border-bottom: 1px solid #eee; pointer-events: none;"></div>
    {% endfor %}
    <!-- Render event dạng block kéo dài -->
    {% for event in events %}
      {% set start_minutes = event.todo.start_time.hour * 60 + event.todo.start_time.minute %}
      {% set end_minutes = event.todo.end_time.hour * 60 + event.todo.end_time.minute %}
      {% set top = (start_minutes / 60) * 48 %}
      {% set height = ((end_minutes - start_minutes) / 60) * 48 %}
      {% set left = (event.column / event.total_columns) * 98 %}
      {% set width = (1 / event.total_columns) * 98 - 4 %}
      {% set tag_color = {
        'work':   '#B2D7FF',
        'study':  '#FFE6A7',
        'personal': '#FFD6E0',
        'meeting': '#D6FFD6',
        'health': '#E0D6FF',
        'family': '#FFF2B2',
        'travel': '#B2FFF2',
        'other':  '#F5F5F5'
      }.get(event.todo.tag|lower, '#BDFFDB') %}
      {% set tag_border = {
        'work':   '#5CA8F7',
        'study':  '#FFC14A',
        'personal': '#FF7A9E',
        'meeting': '#8EDBB2',
        'health': '#A18CFF',
        'family': '#FFD84A',
        'travel': '#4ADBC1',
        'other':  '#8EDBB2'
      }.get(event.todo.tag|lower, '#8EDBB2') %}
      <div class="event-block" 
        style="position: absolute; top: {{ top }}px; left: {{ left }}%; width: {{ width }}%; height: {{ height }}px; background: {{ tag_color }}; border-radius: 4px; border: 1.5px solid {{ tag_border }}; box-shadow: 0 2px 8px #0001; padding: 6px 10px; cursor: pointer; overflow: hidden; z-index: 2;"
        onclick="window.location.href='/edit-event/{{ event.todo.id }}'"
        >
        <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
          <span style="color: #2C5A41; font-size: 13px; font-weight: bold;">{{ event.todo.task }}</span>
          <span style="color: #2C5A41; font-size: 12px; font-weight: bold;">{{ event.todo.start_time.strftime('%H:%M') }}-{{ event.todo.end_time.strftime('%H:%M') }}</span>
        </div>
        <span style="color: #2C5A41; font-size: 11px; white-space: pre-line;">{{ event.todo.description }}</span>
      </div>
    {% endfor %}
  </div>
</div>
<script>
function showEventDetail(id) {
  document.getElementById('event-popup-' + id).style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeEventPopup(id) {
  document.getElementById('event-popup-' + id).style.display = 'none';
  document.body.style.overflow = '';
}
	// Calendar logic
	const calendar = document.getElementById('calendar');
	const calendarMonth = document.getElementById('calendarMonth');
	const prevMonthBtn = document.getElementById('prevMonth');
	const nextMonthBtn = document.getElementById('nextMonth');

	let today = new Date();
	let currentMonth = today.getMonth();
	let currentYear = today.getFullYear();

	function renderCalendar(month, year, selectedDateStr = null) {
		const monthNames = [
			'January', 'February', 'March', 'April', 'May', 'June',
			'July', 'August', 'September', 'October', 'November', 'December'
		];
		calendarMonth.textContent = monthNames[month] + ' ' + year;
		const firstDay = new Date(year, month, 1).getDay();
		const daysInMonth = new Date(year, month + 1, 0).getDate();
		let html = '<tr>';
		const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
		for (let d of days) html += `<th style=\"color:#888;font-size:12px;\">${d}</th>`;
		html += '</tr><tr>';
		for (let i = 0; i < firstDay; i++) html += '<td></td>';
		for (let date = 1; date <= daysInMonth; date++) {
			if ((firstDay + date - 1) % 7 === 0 && date !== 1) html += '</tr><tr>';
			const isToday = date === today.getDate() && month === today.getMonth() && year === today.getFullYear();
			const thisDateStr = `${year}-${month+1}-${date}`;
			const isSelected = selectedDateStr === thisDateStr;
			// Ưu tiên selected, nếu đã chọn thì không bôi màu today nữa
			const isHighlight = isSelected ? 'selected' : '';
			const bgColor = isSelected ? '#0B41FF' : (isToday ? '#F5F5F5' : '#F5F5F5');
			const color = isSelected ? '#fff' : '#333';
			html += `<td class="${isHighlight}" style=\"padding:4px;\"><button class=\"calendar-day\" data-date=\"${thisDateStr}\" style=\"width:28px;height:28px;border-radius:50%;border:none;background:${bgColor};color:${color};font-weight:bold;cursor:pointer;\">${date}</button></td>`;
		}
		const lastDay = (firstDay + daysInMonth - 1) % 7;
		for (let i = lastDay + 1; i < 7 && lastDay !== 6; i++) html += '<td></td>';
		html += '</tr>';
		calendar.innerHTML = html;
		document.querySelectorAll('.calendar-day').forEach(btn => {
			btn.onclick = function() {
				const dateStr = this.getAttribute('data-date');
				// Chuyển hướng sang backend để lấy event đúng ngày
				window.location.href = '/day?date=' + dateStr;
			};
		});
	}

	let selectedDate = null;

	// Lấy ngày hiện tại làm ngày chọn mặc định khi load trang
	window.onload = function() {
		// Lấy ngày từ query string nếu có
		const params = new URLSearchParams(window.location.search);
		let dateStr = params.get('date');
		let defaultDate;
		if (dateStr) {
			// Định dạng YYYY-MM-DD
			const [y, m, d] = dateStr.split('-').map(Number);
			defaultDate = new Date(y, m - 1, d);
			selectedDate = dateStr;
		} else {
			defaultDate = new Date(currentYear, currentMonth, today.getDate());
			selectedDate = `${defaultDate.getFullYear()}-${defaultDate.getMonth()+1}-${defaultDate.getDate()}`;
		}
		renderCalendar(defaultDate.getMonth(), defaultDate.getFullYear(), selectedDate);
		// Cập nhật ngày lớn
		const day = String(defaultDate.getDate()).padStart(2, '0');
		const monthName = defaultDate.toLocaleString('default', { month: 'long' });
		document.querySelectorAll('span[style*="font-size: 30px"]')[0].textContent = `${day} ${monthName} ${defaultDate.getFullYear()}`;
		// Cập nhật lại currentMonth/currentYear để điều hướng tháng đúng
		currentMonth = defaultDate.getMonth();
		currentYear = defaultDate.getFullYear();
	};

	prevMonthBtn.onclick = function() {
		currentMonth--;
		if (currentMonth < 0) {
			currentMonth = 11;
			currentYear--;
		}
		renderCalendar(currentMonth, currentYear, selectedDate);
	};
	nextMonthBtn.onclick = function() {
		currentMonth++;
		if (currentMonth > 11) {
			currentMonth = 0;
			currentYear++;
		}
		renderCalendar(currentMonth, currentYear, selectedDate);
	};

	renderCalendar(currentMonth, currentYear);
	</script>
</body>
</html>
