<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Day</title>
	<style>
		body {
			font-family: system-ui;
		}
		.calendar-container {
			position: absolute;
			top: 30px;
			right: 40px;
			background: #fff;
			border-radius: 10px;
			box-shadow: 0 2px 8px #0002;
			padding: 20px;
			width: 320px;
		}
		.calendar-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.calendar-header button {
			background: #0B41FF;
			color: #fff;
			border: none;
			border-radius: 4px;
			padding: 4px 10px;
			font-size: 16px;
			cursor: pointer;
		}
		.calendar-header span {
			font-size: 18px;
			font-weight: bold;
		}
		table.calendar {
			width: 100%;
			border-collapse: collapse;
			text-align: center;
		}
		table.calendar th, table.calendar td {
			padding: 6px;
			font-size: 15px;
		}
		table.calendar th {
			color: #0B41FF;
		}
		table.calendar td.selected {
			background: #0B41FF;
			color: #fff;
			border-radius: 50%;
		}
		table.calendar td:hover {
			background: #e6f0ff;
			cursor: pointer;
			border-radius: 50%;
		}
	</style>
</head>
<body>
	<div style="background: #FFFFFF; min-height: 100vh; position: relative;">
        <div class="calendar-container" id="calendar-box" style="display: none;">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)">&lt;</button>
                <span id="calendar-month"></span>
                <button onclick="changeMonth(1)">&gt;</button>
            </div>
            <table class="calendar">
                <thead>
                    <tr>
                        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    <!-- Calendar days will be rendered here -->
                </tbody>
            </table>
        </div>
		<div style="background: #FFFFFF;">
		<div style="align-self: stretch; display: flex; align-items: flex-start; background: #FFFFFF; border-radius: 6px; margin-top: 30px; margin-bottom: 1px; box-shadow: 0px 14px 21px #00000040;">
			<div style="flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-start; background: #FFFFFF; padding-bottom: 245px; min-width: 260px;">
				<div id="calendar-container" style="width: 240px; padding: 16px;">
					<div style="display: flex; justify-content: space-between; align-items: center;">
						<button id="prevMonth" style="background: none; border: none; font-size: 18px; cursor: pointer;">&#8592;</button>
						<span id="calendarMonth" style="color: #333; font-size: 18px; font-weight: bold;"></span>
						<button id="nextMonth" style="background: none; border: none; font-size: 18px; cursor: pointer;">&#8594;</button>
					</div>
					<table id="calendar" style="width: 100%; margin-top: 10px; border-collapse: collapse; text-align: center;"></table>
				</div>
				<!-- Block Sự kiện trong ngày ngay bên dưới calendar -->
				<div style="width: 100%; margin-top: 24px;">
					<h3 style="margin-bottom: 12px; color: #0B41FF; font-size: 16px; text-align:center;">Sự kiện trong ngày</h3>
					{% if todos %}
						<ul style="list-style: none; padding: 0; margin: 0;">
							{% for todo in todos|sort(attribute='start_time') %}
								<li data-event-title-today="{{ todo.task }}" style="margin-bottom: 10px; padding: 10px 8px; background: #fff; border-radius: 6px; box-shadow: 0 1px 4px #0001; display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
									<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
										<span style="font-weight: bold; color: #0B41FF; font-size: 15px;">{{ todo.task }}</span>
										<span style="color: #666; font-size: 13px; font-weight: bold;">{{ todo.start_time.strftime('%H:%M') if todo.start_time else '' }} - {{ todo.end_time.strftime('%H:%M') if todo.end_time else '' }}</span>
										{% if todo.tag %}
											<span style="color: #fff; background: #0B41FF; border-radius: 8px; font-size: 11px; padding: 2px 8px; margin-left: 8px;">#{{ todo.tag }}</span>
										{% endif %}
									</div>
									<!-- Không hiển thị description ở cột trái -->
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<div style="color: #888; font-size: 14px; text-align:center;">Không có sự kiện nào trong ngày này.</div>
					{% endif %}
				</div>
				<!-- Block Sự kiện ngày mai -->
				<div style="width: 100%; margin-top: 18px;">
					<h3 style="margin-bottom: 12px; color: #FF7A00; font-size: 16px; text-align:center;">Sự kiện ngày mai</h3>
					{% if todos_tomorrow %}
						<ul style="list-style: none; padding: 0; margin: 0;">
							{% for todo in todos_tomorrow|sort(attribute='start_time') %}
								<li data-event-title-tomorrow="{{ todo.task }}" style="margin-bottom: 10px; padding: 10px 8px; background: #fff; border-radius: 6px; box-shadow: 0 1px 4px #0001; display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
									<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
										<span style="font-weight: bold; color: #FF7A00; font-size: 15px;">{{ todo.task }}</span>
										<span style="color: #666; font-size: 13px; font-weight: bold;">{{ todo.start_time.strftime('%H:%M') if todo.start_time else '' }} - {{ todo.end_time.strftime('%H:%M') if todo.end_time else '' }}</span>
										{% if todo.tag %}
											<span style="color: #fff; background: #FF7A00; border-radius: 8px; font-size: 11px; padding: 2px 8px; margin-left: 8px;">#{{ todo.tag }}</span>
										{% endif %}
									</div>
									<!-- Không hiển thị description ở cột trái -->
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<div style="color: #888; font-size: 14px; text-align:center;">Không có sự kiện nào cho ngày mai.</div>
					{% endif %}
				</div>
			</div>
			<div style="flex: 1;">
				<div style="align-self: stretch; display: flex; align-items: flex-start; background: #FFFFFF; border-bottom: 1px solid #DADCE099; padding: 6px 16px 16px 16px; margin-left: 1px; margin-right: 1px;">
					<div style="flex-shrink: 0; display: flex; align-items: center; margin-top: 10px;">
						<span style="color: #333333; font-size: 30px; font-weight: bold; margin-right: 21px;" id="dayTitle">
							<!-- dynamic date here -->
						</span>
						<button style="flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-start; background: none; border-radius: 3px; border: 1px solid #0B41FF; padding: 8px; text-align: left; margin-right:8px;"
							onclick="window.location.href='/week?date=' + encodeURIComponent(selectedDate)">
							<span style="color: #0B41FF; font-size: 12px; font-weight: bold;">Week</span>
						</button>
						<button style="flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-start; background: none; border-radius: 3px; border: 1px solid #0B41FF; padding: 8px; text-align: left; margin-right:8px;"
							onclick="goToCurrentDay()">
							<span style="color: #0B41FF; font-size: 12px; font-weight: bold;">Hiện tại</span>
						</button>
					</div>
					<div style="flex: 1; align-self: stretch;">
					</div>
					<img
    src="{% if user and user.avatar %}/static/avatar/{{ user.avatar }}{% elif user and (user.username|default('')) and (user.username+'.png') in (os.listdir('static/avatar') if os.path.exists('static/avatar') else []) %}/static/avatar/{{ user.username }}.png{% else %}https://via.placeholder.com/60{% endif %}"
    class="avatar-img"
    alt="avatar"
    onclick="window.location.href='/profile'"
    style="width: 48px; height: 48px; margin-right: 19px; object-fit: fill; cursor: pointer; border-radius: 50%;"
/>
					<div style="flex-shrink: 0; display: flex; align-items: center; margin-top: 14px; gap: 16px;">
						<div style="flex-shrink: 0; display: flex; align-items: center; background: #F5F5F5; border-radius: 99px; padding: 8px 8px 8px 16px; position:relative;">
							<input
								type="text"
								placeholder="Enter Search"
								id="eventSearchInput"
								style="color: #6A778B; font-size: 14px; font-weight: bold; width: 161px; background: none; border: none; z-index:2;"
							/>
							<img
								src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/5c0f54db-ffe1-4c35-b9e2-893e888c3290" 
								style="border-radius: 99px; width: 16px; height: 16px; object-fit: fill; z-index:2;"
							/>
							<div id="search-suggestion-box" style="display:none; position:absolute; left:0; right:0; top:38px; z-index:100; background:#fff; border-radius:8px; box-shadow:0 2px 8px #0002; padding:8px 0; max-height:220px; overflow-y:auto;"></div>
						</div>
						<button style="flex-shrink: 0; display: flex; align-items: center; background: #0B41FF; border-radius: 3px; border: none; padding: 8px; gap: 4px; text-align: left;"
							onclick="window.location.href='/add-event'">
							<span style="color: #FFFFFF; font-size: 12px; font-weight: bold;" >
								Add event
							</span>
							<img
								src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/97437b4c-b5ea-45f9-aeb1-75d8a938a534" 
								style="border-radius: 3px; width: 16px; height: 16px; object-fit: fill;"
							/>
						</button>
					</div>
				</div>
				<div style="align-self: stretch; display: flex; align-items: flex-start; margin-left: 1px; margin-right: 1px;">
  <div style="flex-shrink: 0; display: flex; flex-direction: column; align-items: center; width: 60px;">
    {% for hour in range(24) %}
      <div style="height: 48px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #eee; width: 100%; box-sizing: border-box;">
        <span style="color: #333333; font-size: 12px; font-weight: bold;">{{ '%02d:00' % hour }}</span>
      </div>
    {% endfor %}
  </div>
  <!-- Cột nội dung bên phải: event kéo dài và xếp chồng -->
  <div style="flex: 1; position: relative; min-height: 1152px; background: #fff; border-radius: 6px; overflow: visible;">
    <!-- Render các ô giờ làm nền -->
    {% for hour in range(24) %}
      <div style="position: absolute; left: 0; right: 0; top: {{ hour*48 }}px; height: 48px; border-bottom: 1px solid #eee; pointer-events: none;"></div>
    {% endfor %}
    <!-- Render event dạng block kéo dài -->
    {% for event in events %}
      {% set start_minutes = event.todo.start_time.hour * 60 + event.todo.start_time.minute %}
      {% set end_minutes = event.todo.end_time.hour * 60 + event.todo.end_time.minute %}
      {% set top = (start_minutes / 60) * 48 %}
      {% set height = ((end_minutes - start_minutes) / 60) * 48 %}
      {% set left = (event.column / event.total_columns) * 100 %}
      {% set width = (1 / event.total_columns) * 100 - 2 %}
      {% set tag_color = {
        'work':   '#B2D7FF',
        'study':  '#FFE6A7',
        'personal': '#FFD6E0',
        'meeting': '#D6FFD6',
        'health': '#E0D6FF',
        'family': '#FFF2B2',
        'travel': '#B2FFF2',
        'other':  '#F5F5F5'
      }.get(event.todo.tag|lower, '#BDFFDB') %}
      {% set tag_border = {
        'work':   '#5CA8F7',
        'study':  '#FFC14A',
        'personal': '#FF7A9E',
        'meeting': '#8EDBB2',
        'health': '#A18CFF',
        'family': '#FFD84A',
        'travel': '#4ADBC1',
        'other':  '#8EDBB2'
      }.get(event.todo.tag|lower, '#8EDBB2') %}
      <div class="event-block" 
        data-tag="{{ event.todo.tag|default('') }}"
        style="position: absolute; top: {{ top }}px; left: calc({{ left }}% + {{ event.column * 6 }}px); width: calc({{ width }}% - 8px); height: {{ height }}px; background: {{ tag_color }}; border-radius: 4px; border: 1.5px solid {{ tag_border }}; box-shadow: 0 2px 8px #0001; padding: 6px 10px; cursor: pointer; overflow: hidden; z-index: {{ 100 - event.column }}; margin: 2px;"
        onclick="window.location.href='/edit-event/{{ event.todo.id }}'"
        >
        <div style="display: flex; flex-direction: column; align-items: flex-start; width: 100%; gap: 2px;">
          <span style="color: #2C5A41; font-size: 13px; font-weight: bold; word-break: break-word; white-space: pre-line;">{{ event.todo.task }}</span>
          <span style="color: #2C5A41; font-size: 12px; font-weight: bold; word-break: break-word; white-space: pre-line;">{{ event.todo.start_time.strftime('%H:%M') }}-{{ event.todo.end_time.strftime('%H:%M') }}</span>
        </div>
        <span style="color: #2C5A41; font-size: 11px; white-space: pre-line; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">{{ event.todo.description }}</span>
      </div>
    {% endfor %}
  </div>
</div>
<script>
// Debounce function to optimize performance
function debounce(func, wait) {
	let timeout;
	return function executedFunction(...args) {
		const later = () => {
			clearTimeout(timeout);
			func(...args);
		};
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
	};
}
// Normalize text for search
function normalizeText(str) {
	return (str || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
}
// Filter events based on search input (chỉ focus event-block trên bảng lịch, search theo tag)
const filterEvents = debounce(function() {
	const keyword = normalizeText(document.getElementById('eventSearchInput').value.trim());
	const suggestionBox = document.getElementById('search-suggestion-box');
	let matches = [];
	document.querySelectorAll('.event-block').forEach((item, idx) => {
		const title = normalizeText(item.querySelector('span').textContent);
		const tag = normalizeText(item.getAttribute('data-tag') || '');
		const timeSpan = item.querySelector('span[style*="font-size: 12px"]');
		const time = timeSpan ? timeSpan.textContent.trim() : '';
		if (keyword && (title.includes(keyword) || tag.includes(keyword))) {
			matches.push({
				title: item.querySelector('span').textContent,
				time: time,
				tag: tag,
				element: item
			});
		}
	});
	// Sort matches by time
	matches.sort((a, b) => {
		const timeA = a.time ? a.time.split('-')[0].trim() : '23:59';
		const timeB = b.time ? b.time.split('-')[0].trim() : '23:59';
		return timeA.localeCompare(timeB);
	});
	// Display suggestions
	if (keyword && matches.length > 0) {
		let html = matches.slice(0, 10).map((match, idx) => `
			<div class="search-suggestion-item" data-idx="${idx}" style="padding:6px 18px; cursor:pointer; font-size:15px; color:#0B41FF; border-bottom:1px solid #F0F0F0; display:flex; justify-content:space-between; align-items:center;" tabindex="0">
				<span>${match.title} ${match.tag ? `<span style=\"color:#666;font-size:13px;margin-left:8px;\">#${match.tag}</span>` : ''}</span>
				${match.time ? `<span style=\"color:#666;font-size:13px;margin-left:12px;\">${match.time}</span>` : ''}
			</div>
		`).join('');
		suggestionBox.innerHTML = html;
		suggestionBox.style.display = '';
		Array.from(suggestionBox.children).forEach((child, idx) => {
			child.onclick = () => selectSuggestion(idx);
			child.onkeydown = e => {
				if (e.key === 'Enter') selectSuggestion(idx);
			};
		});
		highlightSuggestion(-1);
	} else if (keyword) {
		suggestionBox.innerHTML = `<div style=\"padding:6px 18px; font-size:15px; color:#666;\">Không tìm thấy sự kiện nào</div>`;
		suggestionBox.style.display = '';
	} else {
		suggestionBox.style.display = 'none';
	}
}, 300);
// Select a suggestion (focus event-block trên bảng lịch)
function selectSuggestion(idx) {
	const suggestionBox = document.getElementById('search-suggestion-box');
	const keyword = normalizeText(document.getElementById('eventSearchInput').value.trim());
	let matches = [];
	document.querySelectorAll('.event-block').forEach((item) => {
		const title = normalizeText(item.querySelector('span').textContent);
		const tag = normalizeText(item.getAttribute('data-tag') || '');
		if (keyword && (title.includes(keyword) || tag.includes(keyword))) {
			matches.push(item);
		}
	});
	if (matches[idx]) {
		const el = matches[idx];
		el.scrollIntoView({ behavior: 'smooth', block: 'center' });
		el.classList.add('search-highlight');
		setTimeout(() => el.classList.remove('search-highlight'), 1200);
		suggestionBox.style.display = 'none';
		document.getElementById('eventSearchInput').blur();
	}
}
// Highlight suggestion
let currentSuggestion = -1;
function highlightSuggestion(idx) {
	const suggestionBox = document.getElementById('search-suggestion-box');
	Array.from(suggestionBox.children).forEach((child, i) => {
		child.style.background = i === idx ? '#e6f0ff' : '';
	});
	currentSuggestion = idx;
}
// Calendar logic
const calendar = document.getElementById('calendar');
const calendarMonth = document.getElementById('calendarMonth');
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');
let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();
let selectedDate = null;
function renderCalendar(month, year, selectedDateStr = null) {
	const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
	calendarMonth.textContent = monthNames[month] + ' ' + year;
	const firstDay = new Date(year, month, 1);
	const lastDay = new Date(year, month + 1, 0);
	let html = '';
	html += '<thead><tr>';
	const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
	for (let d of days) html += `<th style="color:#888;font-size:12px;">${d}</th>`;
	html += '</tr></thead><tbody>';
	let startDay = (firstDay.getDay() + 6) % 7;
	let day = 1;
	for (let i = 0; i < 6; i++) {
		html += '<tr>';
		for (let j = 0; j < 7; j++) {
			if (i === 0 && j < startDay) {
				html += '<td></td>';
			} else if (day > lastDay.getDate()) {
				html += '<td></td>';
			} else {
				const dateObj = new Date(year, month, day);
				const thisDateStr = `${year}-${month+1}-${day}`;
				const isSelected = selectedDateStr === thisDateStr;
				const isToday = dateObj.getDate() === today.getDate() && dateObj.getMonth() === today.getMonth() && dateObj.getFullYear() === today.getFullYear();
				const isHighlight = isSelected ? 'selected' : '';
				const bgColor = isSelected ? '#0B41FF' : (isToday ? '#F5F5F5' : '#F5F5F5');
				const color = isSelected ? '#fff' : '#333';
				html += `<td class="${isHighlight}" style="padding:4px;"><button class="calendar-day" data-date="${thisDateStr}" style="width:28px;height:28px;border-radius:50%;border:none;background:${bgColor};color:${color};font-weight:bold;cursor:pointer;">${day}</button></td>`;
				day++;
			}
		}
		html += '</tr>';
		if (day > lastDay.getDate()) break;
	}
	html += '</tbody>';
	calendar.innerHTML = html;
	document.querySelectorAll('.calendar-day').forEach(btn => {
		btn.onclick = function() {
			const dateStr = this.getAttribute('data-date');
			window.location.href = '/day?date=' + dateStr;
		};
	});
}
window.onload = function() {
	const params = new URLSearchParams(window.location.search);
	let dateStr = params.get('date');
	let defaultDate;
	if (dateStr) {
		const [y, m, d] = dateStr.split('-').map(Number);
		defaultDate = new Date(y, m - 1, d);
		selectedDate = dateStr;
	} else {
		defaultDate = new Date(currentYear, currentMonth, today.getDate());
		selectedDate = `${defaultDate.getFullYear()}-${defaultDate.getMonth()+1}-${defaultDate.getDate()}`;
	}
	renderCalendar(defaultDate.getMonth(), defaultDate.getFullYear(), selectedDate);
	const day = String(defaultDate.getDate()).padStart(2, '0');
	const monthName = defaultDate.toLocaleString('default', { month: 'long' });
	document.querySelectorAll('span[style*="font-size: 30px"]')[0].textContent = `${day} ${monthName} ${defaultDate.getFullYear()}`;
	currentMonth = defaultDate.getMonth();
	currentYear = defaultDate.getFullYear();
};
prevMonthBtn.onclick = function() {
	currentMonth--;
	if (currentMonth < 0) {
		currentMonth = 11;
		currentYear--;
	}
	renderCalendar(currentMonth, currentYear, selectedDate);
};
nextMonthBtn.onclick = function() {
	currentMonth++;
	if (currentMonth > 11) {
		currentMonth = 0;
		currentYear++;
	}
	renderCalendar(currentMonth, currentYear, selectedDate);
};
// Search event listeners
const searchInput = document.getElementById('eventSearchInput');
const suggestionBox = document.getElementById('search-suggestion-box');
searchInput.addEventListener('input', filterEvents);
searchInput.addEventListener('focus', () => {
	if (suggestionBox.innerHTML) suggestionBox.style.display = '';
});
searchInput.addEventListener('keydown', e => {
	const items = Array.from(suggestionBox.children);
	if (!items.length || suggestionBox.style.display === 'none') return;
	if (e.key === 'ArrowDown') {
		e.preventDefault();
		let next = (currentSuggestion + 1) % items.length;
		highlightSuggestion(next);
		items[next].scrollIntoView({ block: 'nearest' });
	} else if (e.key === 'ArrowUp') {
		e.preventDefault();
		let prev = (currentSuggestion - 1 + items.length) % items.length;
		highlightSuggestion(prev);
		items[prev].scrollIntoView({ block: 'nearest' });
	} else if (e.key === 'Enter') {
		if (currentSuggestion >= 0) {
			selectSuggestion(currentSuggestion);
			e.preventDefault();
		}
	} else if (e.key === 'Escape') {
		suggestionBox.style.display = 'none';
		currentSuggestion = -1;
		searchInput.blur();
	}
});
document.addEventListener('click', e => {
	if (!searchInput.contains(e.target) && !suggestionBox.contains(e.target)) {
		suggestionBox.style.display = 'none';
		currentSuggestion = -1;
	}
});
function goToCurrentDay() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
    window.location.href = '/day?date=' + dateStr;
}
	</script>
</body>
</html>
